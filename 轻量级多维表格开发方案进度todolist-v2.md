# 轻量级多维表格开发方案进度todolist-v2 (v0.0.4 对齐)

本版本聚焦“功能完善 + 关键体验提升”，暂不做大规模 UI 美化，仅预留接入 Element Plus 的消息/抽屉/图标接口。遵循“网格直编”核心思路，保证在私域、低带宽、≤1000 行、≤100 列场景下稳定使用。

---

## 1. 目标与定位
- 版本目标：对齐 v0.0.4，完善表格增删改、字段与类型、筛选/排序/分页、权限颗粒度、并发与冲突处理、工程化与性能保障。
- 交付形式：可运行、可预览；输出本清单、验收标准与自测清单、已知限制；Docker/Compose dev 场景自动 db push。
- 取舍：UI 保持工程化（不美化），预留后续接入 Element Plus 的接口层。

## 2. 范围（Scope）
- 网格直编：新增/删除记录、编辑单元格、右键菜单（插入/删除/清空/复制/粘贴）、快捷键（Enter/Tab/Shift+Enter/方向键/复制粘贴）。
- 自动保存：失焦与定时自动保存并行；支持撤销/重做与乐观更新；冲突处理延续现有机制。
- 类型化编辑器（首批）：日期、枚举多选、数值、引用；内联校验与格式化（千分位/小数位/百分比/日期显示）。
- 筛选/排序：右侧抽屉 + 条件标签化 + 一键清空；点击“应用”后统一加载逻辑并持久化到 `configJson`。
- 权限与只读：字段级/记录级只读；UI 禁用编辑交互；403 轻提示。
- 性能：行级虚拟滚动与分块加载（不做无限滚动）；确保 ≤1000×100 场景顺畅。
- 工程：Docker/Compose（dev）自动执行 `db push`；保留现有 prisma 脚本；消息/抽屉接口层封装。

## 3. 非目标（Out of Scope）
- 移动端适配、多人实时协作指示器。
- 大规模 UI 主题与视觉重构、品牌色与暗黑模式。
- 修订版本面板/变更概览（审计）。
- 多语言（仅中文）。

## 4. 技术基线与约束
- 前端：Vue 3 + Vite；现用 Luckysheet（MIT，完全开源，便于私域部署）。
- 后端：NestJS + Prisma + SQLite；`DATABASE_URL` 配置；已有 seed/测试脚本。
- 浏览器：Chrome 最新版优先；Edge（Chromium）兼容；IE11 不支持（保留只读降级可能）。
- 数据规模：≤1000 行、≤100 列；内网带宽约 1MB。

## 5. 阶段拆分
- M2（当前迭代，v0.0.4 对齐）
  - 网格增强：自动保存/撤销重做/乐观更新、右键菜单与快捷键、类型化编辑器（首批）、内联校验与格式化、右侧抽屉与加载统一、权限只读、虚拟滚动与分块加载。
  - 工程增强：Docker dev 自动 `db push`；消息/抽屉接口层封装。
- M3（排队，下轮迭代）
  - 元数据/权限完善、引用关系体验、复制粘贴跨页清洗、校验规则可视化、消息/抽屉迁移到 Element Plus。
- M4（排队）
  - UI 统一风格、主题与图标体系；协作能力与审计。

## 6. 任务清单（按优先级）
### P0（必须完成）
- 新增记录入口与尾行新增
  - 工具栏“新增记录”；创建后聚焦首个可编辑单元格。
  - 尾行回车/点击新增空行，行号连续。
  - 文件：`web/src/views/GridView.vue`，可能涉及 `web/src/services/api.ts`。
- 自动保存 + 撤销/重做 + 乐观更新
  - 失焦立即保存；定时批量保存（默认 4 秒去抖合并，每次最多 200 单元格）。
  - 客户端历史栈（会话内，最大 100 步）；Ctrl/Cmd+Z、Ctrl/Cmd+Y。
  - 乐观更新渲染；失败/冲突回滚与高亮提示。
- 类型化编辑器（首批）
  - 数值：步进器/合法性（整数/小数）、格式化（千分位/小数位/百分比）。
  - 日期：日期选择器（yyyy-MM-dd），合法性校验。
  - 枚举多选：下拉多选（从字段 `optionsJson` 读取）。
  - 引用：搜索选择（后端分页接口）。
- 内联校验与格式化
  - 非法输入单元格红框/角标提示；格式化仅展示层，不污染原始值。
  - 数值格式化与日期显示按字段配置/默认值渲染。
- 右键菜单与快捷键（首批）
  - 右键：插入行、删除行、清空、复制、粘贴。
  - 快捷：Enter / Shift+Enter / Tab / 方向键 / 复制粘贴（基础）。
- 右侧抽屉：筛选/排序
  - 条件标签化、一键清空；复用统一加载；应用后写入 `configJson`。
- 权限与只读
  - 字段/记录只读标记；UI 层禁用交互；403 轻提示（消息接口层）。

### P1（本轮尽量完成）
- 行级虚拟滚动与分块加载
  - 模式：前端一次性承载至 1000 行；滚动窗口化渲染（容器高度 + 缓冲区）。
  - 维持滚动稳定性与行高一致；必要时后台分块拉取但前端聚合成“单页”。
- Docker/Compose 自动 `db push`（dev）
  - 后端容器启动脚本在 dev 模式执行 `npx prisma db push`，确保首次启动可用。
- 消息/抽屉接入层
  - 封装 `useMessage()` 与 `useDrawer()` 薄层，替代 `alert`；未来可平滑切换到 Element Plus。

### P2（预研与预留）
- 网格引擎评估补充报告
  - 私域低带宽与 ≤1000×100 场景下性能与边界，替换引擎成本评估。
- 浏览器兼容策略
  - Edge Chromium polyfill；IE11 仅只读预览的降级提案（如必要）。

## 7. 实施规则与参数（默认）
- 自动保存：失焦立即；定时批量 4s 合并/批（最大 200 单元格）。
- 撤销/重做：会话内最多 100 步；刷新即清空。
- 数值/百分比：输入 `0.15` 显示 `15%`；输入 `15%` 解析为 `0.15` 存储；千分位/小数位按字段 `optionsJson`。
- 日期：存储 ISO/日期字符串；显示 `yyyy-MM-dd`（本地时区渲染）。
- 枚举多选：选项来自字段 `optionsJson`。
- 引用：后端搜索 API（分页返回）；若后端暂缺接口，先用静态数据占位并标注限制。
- 校验失败：错误单元格不参与自动保存，保留错误态直至用户修正。
- 排序：单字段排序（与现有保持一致）。
- 复制粘贴：纯文本（Tab/换行分隔）与 Excel/CSV；按单元格矩阵填充；遵循字段校验。

## 8. 建议接口契约（引用搜索）
- `GET /api/tables/:tableId/refs?fieldId={id}&q={keyword}&page=1&size=20`
  - 响应：`{ data: Array<{ id: number|string, label: string }>, total: number }`
  - 若已有既定接口，请以后端实际为准。

## 9. 文件落点（主要修改）
- `web/src/views/GridView.vue`：网格编辑增强（新增/尾行、自动保存、撤销/重做、右键与快捷、抽屉、虚拟滚动）。
- `web/src/services/api.ts`：引用搜索、记录/字段权限读取等接口调用。
- `docker-compose.yml`、`Dockerfile.backend`：dev 模式自动 `db push` 逻辑。
- `docs/*`：如需补充运行与限制说明。

## 10. 验收标准
- 新增与编辑
  - 工具栏新增、尾行新增可用；新增后聚焦首可编辑单元格。
  - 失焦与定时自动保存生效；撤销/重做工作正常；乐观更新失败时回滚且提示明确。
- 类型化与校验/格式化
  - 数值/日期/枚举多选/引用均可格内编辑；非法输入即时标红提示。
  - 格式化：千分位/小数位/百分比/日期展示正确。
- 右键菜单与快捷键
  - 右键操作准确；Enter/Shift+Enter/Tab/方向键/复制粘贴按预期。
- 筛选/排序抽屉与加载统一
  - 抽屉标签化与一键清空；应用后统一加载并将条件持久化到 `configJson`。
- 权限只读
  - 只读字段/记录不可编辑且有视觉区分；403 时轻提示，不用阻断弹窗。
- 性能
  - ≤1000×100 渲染滚动与编辑流畅，无明显抖动与高内存增长。
- Docker/Compose
  - `docker-compose up -d`（dev）后，后端自动完成 `db push`，首次访问不出现空表结构故障。
- 浏览器
  - Chrome 最新版通过；Edge（Chromium）基本功能通过。

## 11. 自测清单（附录）
- 新增/编辑/保存：新增两种入口、失焦保存、定时保存、撤销/重做、冲突与回滚。
- 类型化/校验/格式化：四类编辑器的合法/不合法输入、格式化展示。
- 快捷/右键：5 个高频快捷与右键 5 项功能验证。
- 筛选/排序：抽屉交互、标签化与清空、应用后加载与 `configJson` 持久化。
- 权限：只读字段/记录 UI 禁用与 403 轻提示。
- 性能：1000×100 数据填充后的滚动与编辑流畅度。
- Docker：全新环境 `docker-compose up -d` 即可访问、建表与编辑。

## 12. 已知限制与兼容
- IE11 不支持（框架与网格生态不兼容），如强需仅提供只读预览的降级方案（另行评估）。
- Luckysheet 与窗口化渲染整合存在一定复杂度；必要时可退回“分页 + 局部渲染”。
- 引用/枚举多选的选项来源与搜索分页需与后端契约对齐；后端暂缺时先静态化占位。

## 13. 风险与回退
- 自动保存频率过高导致冲突增加：通过 4s 去抖合并、撤销/重做与冲突提示缓解；必要时回退为“仅手动保存”。
- 虚拟滚动渲染异常：允许回退为分页加载 + 局部渲染的保守策略。
- 类型化编辑器边界：先达成最小可用，复杂校验与格式化逐步增强。

## 14. 变更记录
- v2（当前）
  - 明确 v0.0.4 范围、优先级与默认参数；新增自动保存/撤销重做/乐观更新；首批类型化编辑器；右键/快捷键优先级；筛选/排序抽屉与加载统一；权限只读；虚拟滚动与分块加载；Docker dev 自动 `db push`；兼容策略与 IE 降级建议。
- v1（历史）
  - 网格直编、批量保存与冲突处理、分页/筛选/排序、列宽/冻结记忆、导入等内核能力具备。

---

## 15. 预览与运行（附录）
- 前端本地预览：`http://localhost:5173/` 或 `http://localhost:5174/`
- 后端本地（dev）：配置 `DATABASE_URL` 后启动；或使用 Docker/Compose（dev 自动 `db push`）。
- 首次使用：建议通过 `TableDetailView` 快速创建表/字段/记录或导入 CSV，随后创建并进入“网格视图”。

## 16. 里程碑与节点拆分（v0.0.4 / M2）

- 里程碑清单（M2.x）
  - M2.1 新增记录入口与尾行新增（FE）
    - 节点：工具栏“新增记录”、尾行空行新增、聚焦首可编辑单元格、基本用例自测
    - 依赖：`api.createRecord`、现有表结构与权限
    - 验收：两处新增入口均可用、焦点行为正确、与分页/筛选共存
  - M2.2 自动保存 + 撤销/重做 + 乐观更新（FE）
    - 节点：失焦保存、4s 去抖批量（≤200 单元格）、历史栈 100 步、冲突回滚与提示、E2E 用例
    - 依赖：`saveDirty()` 现有并发与冲突逻辑
    - 验收：操作流畅、失败可回滚、冲突可重试
  - M2.3 类型化编辑器（数值/日期/枚举多选/引用）（FE+BE）
    - 节点：数值格式化与校验；日期选择器；枚举多选（optionsJson）；引用搜索选择（分页 API）
    - 依赖：引用搜索 API（若缺则静态占位），字段 optionsJson
    - 验收：四类编辑器可用，非法输入红框提示，显示格式正确
  - M2.4 右键菜单与快捷键（FE）
    - 节点：插入行、删除行、清空、复制、粘贴；Enter/Shift+Enter/Tab/方向键/复制粘贴
    - 依赖：Luckysheet 事件与宿主容器
    - 验收：网格常用操作闭环，和自动保存/撤销不冲突
  - M2.5 右侧抽屉筛选/排序 + 统一加载（FE）
    - 节点：抽屉 UI、标签化、一键清空、应用后统一加载、写入 configJson
    - 依赖：现有筛选/排序序列化与加载逻辑
    - 验收：状态可视、应用与清空一致、刷新后保留
  - M2.6 权限只读与 403 轻提示（FE）
    - 节点：字段/记录只读标记、UI 禁用交互、统一消息接口层
    - 依赖：服务端权限判定返回、全局消息适配
    - 验收：只读状态明显、写入被拦截时轻提示
  - M2.7 行级虚拟滚动与分块加载（FE）
    - 节点：窗口化渲染（≤1000 行）、滚动稳定、必要时分块拉取前端聚合
    - 依赖：Luckysheet 渲染机制与容器高度策略
    - 验收：1000×100 场景流畅无明显抖动
  - M2.8 消息/抽屉接入层（FE）
    - 节点：封装 useMessage/useDrawer；替换 alert；为后续 Element Plus 平滑迁移
    - 依赖：前端基础库
    - 验收：全局统一、无裸 alert
  - M2.9 Docker/Compose（dev）自动 db push（BE/OPS）
    - 节点：dev 启动执行 `npx prisma db push`，首启可用
    - 依赖：docker-compose、Dockerfile.backend、环境变量
    - 验收：全新环境 compose 一键起服可用
  - M2.10 稳定化与验收（ALL）
    - 节点：性能回归、自测清单走查、文档完善
    - 依赖：上述全部
    - 验收：第 10 节验收标准逐项通过

## 17. 详细开发进度计划（含日期/依赖/责任）

- 时间轴（2025-10-27 ~ 2025-11-14，工作日制）
  - 2025-10-27（一）
    - M2.1 设计与实现方案；更新单测/自测用例（Owner: FE）
  - 2025-10-28（二）
    - M2.1 完成与联调；聚焦行为与边界用例（Owner: FE）
    - M2.2 框架与历史栈骨架（Owner: FE）
  - 2025-10-29（三）
    - M2.2 失焦保存与 4s 去抖批量；基础冲突回滚（Owner: FE）
  - 2025-10-30（四）
    - M2.2 撤销/重做与乐观更新；E2E 关键路径（Owner: FE）
  - 2025-10-31（五）
    - M2.2 收尾与文档；启动 M2.3 数值/日期编辑器（Owner: FE）
  - 2025-11-03（一）
    - M2.3 枚举多选（optionsJson）实现（Owner: FE）
  - 2025-11-04（二）
    - M2.3 引用编辑器 + 搜索分页 API（Owner: FE/BE）
  - 2025-11-05（三）
    - M2.4 右键菜单与基础快捷键（Owner: FE）
  - 2025-11-06（四）
    - M2.5 抽屉筛选/排序 + 标签化 + 持久化（Owner: FE）
  - 2025-11-07（五）
    - M2.6 权限只读 + 403 轻提示 + 消息适配（Owner: FE）
  - 2025-11-10（一）
    - M2.7 窗口化渲染（虚拟滚动）实现（Owner: FE）
  - 2025-11-11（二）
    - M2.7 分块拉取与性能调优（Owner: FE）
  - 2025-11-12（三）
    - M2.8 消息/抽屉接入层替换遗留 alert（Owner: FE）
  - 2025-11-13（四）
    - M2.9 Docker dev 自动 db push（Owner: BE/OPS）
  - 2025-11-14（五）
    - M2.10 稳定化、回归与正式验收（Owner: ALL）

- 责任分工与评审
  - FE 负责人：实现 M2.1、M2.2、M2.3、M2.4、M2.5、M2.6、M2.7、M2.8
  - BE/OPS：实现 M2.9；配合 M2.3 引用 API
  - 评审：每个里程碑完成后进行代码与功能评审（Reviewer: 指定同事/你）

- 依赖与前置条件
  - 数据库与后端服务可用；`DATABASE_URL` 与 dev compose 配置正确
  - 若引用搜索 API 未就绪，M2.3 引用编辑器以静态数据占位，标注限制

## 18. 进度记录模板（每节点必须更新）

- 记录要求
  - 每个节点开发完成当日 18:00 前必须更新记录；延误需标注原因
  - 每日更新“进行中节点”实际进展与风险；保持计划-实际对齐
  - 记录需附 PR 链接、可复现步骤与预览链接（若涉及前端）

- 状态枚举
  - Status: [Green|Yellow|Red]（绿：按计划；黄：轻微偏差≤1天；红：偏差>1天或阻塞）

- 模板（Markdown 表格）

| 日期 | 版本/里程碑 | 节点 ID/名称 | 计划起止 | 实际起止 | 完成度 | 状态 | PR/提交 | 预览链接 | 用时(h) | 风险/阻塞 | 调整动作 | 下个计划 | 责任人 | 审核人 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| 2025-10-28 | v0.0.4 / M2.1 | 新增记录入口 | 10-27~10-28 | 10-27~10-28 | 100% | Green | #1234 | http://localhost:5173/ | 12 | 无 | — | 合并回主线 | FE | Reviewer |

- 模板（YAML 便于自动收集）

```yaml
date: 2025-10-28
version: v0.0.4
milestone: M2.1
node: 新增记录入口
plan_range: 2025-10-27 ~ 2025-10-28
actual_range: 2025-10-27 ~ 2025-10-28
progress: 100%
status: Green
prs: ["https://repo/pr/1234"]
preview: "http://localhost:5173/"
hours: 12
risks: []
actions: []
next: "合并回主线，开始 M2.2"
owner: FE
reviewer: Reviewer
```

## 19. 进度纪律与偏差处理（必须遵守）

- 严格按第 17 节计划执行；每日提交“进度记录模板”；节点完成即更新
- 偏差处理
  - Yellow：在 1 个工作日内自消化并在记录中给出纠偏动作
  - Red：立即上报并组织评审，允许调整后续排期，但需在“变更记录”登记
- 禁止事项
  - 未记录直接合入主线；跳过评审；无说明更改范围
- 周例会
  - 每周五收敛本周偏差与下周计划，更新本文档

---

（本次增补）
- 新增第 16~19 节：里程碑与节点拆分、详细进度计划、进度记录模板、进度纪律
- 默认时间轴：2025-10-27 ~ 2025-11-14（可根据人力微调，但需登记变更）
## 20. 节点级进度记录入口（新增）
- 目录：`docs/progress/nodes/`
- 模板：`docs/progress/nodes/node-template.md`
- 要求：每个节点完成当日，必须回填“完成总结与计划调整”，并在本文件的“变更记录”处同步。