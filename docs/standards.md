# 代码风格与提交规范

## 语言与类型
- TypeScript 严格模式：启用 `strict`；尽量避免 `any`；明确返回类型。
- 模块组织：后端按 NestJS 模块划分；前端按页面、组件、状态、服务划分。

## 命名与结构
- 变量/函数：语义化小驼峰；类/类型：大驼峰；常量：全大写下划线。
- 文件：后端模块名统一；前端组件名与目录一致；避免超长文件。
- 目录：保持简洁，避免深层嵌套；公共工具抽到 `utils/`。

## ESLint/Prettier（建议规则）
- ESLint：`no-unused-vars`、`eqeqeq`、`no-implicit-any`、`prefer-const`、`no-console`（后端允许日志模块使用）。
- Prettier：统一行宽、缩进、引号、分号；与 ESLint 协同。

## 错误码与接口规范
- REST 风格：资源路径清晰；动词用在方法上；参数尽量用查询或主体。
- 错误码：
  - `400` 参数错误/校验失败
  - `401` 未认证
  - `403` 无权限（ACL 或只读限制）
  - `404` 不存在
  - `409` 版本冲突（revision 落后）
  - `422` 语义错误（如公式解析失败）
  - `500` 服务内部错误
- 错误响应结构：`{ code, message, details? }`

## 前端组件与状态
- 组件：职责单一，避免多功能耦合；长列表与表格走虚拟滚动。
- 状态：Pinia 模块化；只存必要状态；与后端契约映射清晰。
- 网络：统一请求封装；错误提示一致；重试与刷新策略可配置。

## 公式与数据一致性
- 前端即时重算并标记未保存；后端进行基本校验与可选重算；区域引用遵循 Luckysheet 规则。
- 对只读行/列的编辑请求在前端禁用，在后端拒绝。

## 提交与分支
- 分支命名：`feat/<模块>-<简述>`、`fix/<模块>-<问题>`、`docs/<文档>`、`chore/<维护>`。
- 提交格式：`<type>(<scope>): <subject>`；详见 `docs/contributing.md`。

## 文档与注释
- 必要文档：变更点与接口契约；复杂逻辑补充说明。
- 注释：清晰简短；避免与代码重复；关键算法与边界条件需标注。

## Luckysheet 交互与后端映射（2025-10-24 已确认）
- 结构操作：新增列 `POST /api/tables/:id/fields`；删列软删 `DELETE /api/fields/:id`；新增行 `POST /api/tables/:id/records`；删行软删 `DELETE /api/records/:id`。
- 软删除与性能：查询统一过滤 `deleted_at IS NULL`；在 `1000×100` 规模下影响极小；为热表加 `(table_id, deleted_at)` 索引，必要时定期归档/硬删超期数据。
- 样式持久化：持久化字体、颜色、对齐、合并单元格、行高/列宽于 `views.configJson`（展示层配置），与 EAV 数据层分离。
- 公式策略：仅支持基本算术与引用；以“前端计算为主”，保存时同时写入已计算值与表达式（`formulaExpr`）；后端进行基本校验，冲突默认保留服务器版本。
- 选择字段编辑：使用原生下拉/选择器，强校验合法选项；批量粘贴前做类型校验与提示。
- 过滤/排序：采用 Luckysheet 本地规则作为临时视图；保存时不写入临时排序/筛选；若需跨会话一致性，持久化条件到 `views.configJson`。
- 数据规模与性能：目标 `1000×100`；启用虚拟滚动与分页/分块加载；编辑/粘贴/公式重算做节流与增量重算。
- 权限策略：`viewer` 只读（禁止编辑与结构操作）；`editor` 可编辑单元格但禁止结构操作；`owner/admin` 允许结构变更；前端拦截 + 后端校验双保险。
- 并发与回滚：批量写入使用 `revision`；冲突默认保留服务器版本，提供面板允许用户选择策略。
- 前端即时重算并标记未保存；后端进行基本校验与可选重算；区域引用遵循 Luckysheet 规则。
- 对只读行/列的编辑请求在前端禁用，在后端拒绝。

## 提交与分支
- 分支命名：`feat/<模块>-<简述>`、`fix/<模块>-<问题>`、`docs/<文档>`、`chore/<维护>`。
- 提交格式：`<type>(<scope>): <subject>`；详见 `docs/contributing.md`。

## 文档与注释
- 必要文档：变更点与接口契约；复杂逻辑补充说明。
- 注释：清晰简短；避免与代码重复；关键算法与边界条件需标注。

—— 完 ——