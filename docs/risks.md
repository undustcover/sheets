# 风险与回滚计划

## 主要风险
1) 公式一致性（Luckysheet vs 后端校验）
- 风险：区域引用与汇总计算在前后端表现不一致；边界如空值/非法输入导致计算差异。
- 控制：前端统一公式引擎；后端做基本校验（数值类型/范围），必要时回退为前端固化值为准并标注来源。
- 回滚：禁用复杂公式子集；将相关单元格标记为只读或提示重新计算。

2) 并发与版本冲突
- 风险：保存时 `revision` 落后导致频繁冲突；用户体验受影响。
- 控制：明确冲突提示与一键刷新；减少长会话未刷新；保存前变更检测。
- 回滚：允许局部刷新视图数据；提供最近一次变更回显与重试入口。

3) 权限与只读边界
- 风险：前端漏掉只读禁用或后端校验不严导致越权写入。
- 控制：双重校验（前端禁用 + 后端拒绝）；接口层强制检查。
- 回滚：发现越权后立即热修；审计日志追踪影响范围。

4) 导入列头宽松匹配与本地化解析
- 风险：宽松匹配误判列头；本地化数字/日期解析错误（千分位、小数点、`YYYY-MM-DD`）。
- 控制：导入向导增加预览与人工确认；提供列映射调整；解析失败标记并跳过。
- 回滚：关闭自动创建字段；仅严格匹配模式；提供回滚导入的操作日志与撤销。

5) 移动端体验
- 风险：网格编辑在移动端操作困难；性能受限。
- 控制：降级为浏览与检索；编辑场景推荐桌面端；虚拟滚动优化阈值。
- 回滚：移动端关闭复杂编辑控件；保留基础查看与筛选。

6) 附件存储与清理
- 风险：文件名冲突处理不当；孤儿文件堆积。
- 控制：重命名策略（时间戳/计数）；通过外键关系避免孤儿；定期扫描。
- 回滚：提供清理脚本；压缩与归档旧附件。

7) 分组与聚合性能
- 风险：对过滤结果聚合时响应慢；缓存失效策略混乱。
- 控制：`GROUP BY` 与分页；缓存按过滤条件键值；限制一次聚合的字段数量。
- 回滚：降级聚合范围或延迟执行；提示用户等待与取消。

## 监控与审计
- 日志：`login/import/export/save` 事件记录，包含用户、表/视图、时间、元信息。
- 告警：关键错误聚合并提示；保存冲突与导入解析失败计数。

## 应急处理流程
- 识别问题 → 记录日志与影响范围 → 临时关闭高风险功能子集 → 发布修复 → 验收与回放测试 → 恢复功能。

—— 完 ——