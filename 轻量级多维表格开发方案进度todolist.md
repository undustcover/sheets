# 轻量级多维表格开发方案进度 ToDoList（严格执行版）

本文档为项目的唯一进度清单与执行参考。任何中断、遗忘或上下文缺失时，均以本清单为准继续工作。除非明确完成并标记为 `completed`，不得跳过任意任务。

- 参考设计文档：`f:\trae\sheets\轻量级多维表格设计方案.md`
- 状态约定：`pending | in_progress | blocked | completed`
- 任务字段：`ID / 名称 / 描述 / 产出 / 依赖 / 执行步骤 / 验收标准 / 预计耗时 / 备注`
- 变更策略：新增需求以“追加任务”的方式记录，完成后保持历史不可改。
- 评审节奏：每个里程碑结束进行一次小结评审，记录问题与后续计划。

---

## 里程碑总览
- 里程碑0（准备）：1–2 天
- 里程碑1（后端基础）：1.5–2 周
- 里程碑2（网格与导入导出）：2–3 周
- 里程碑3（看板/画廊/分组聚合）：1.5–2 周
- 里程碑4（Docker与发布）：0.5–1 周

---

## 主计划 ToDoList（严格执行）

### 里程碑0：准备与规范
1) [M0-01] 初始化项目文档结构（状态：completed）
- 描述：创建 `docs/` 结构与 README、贡献指南、任务模板引用。
- 产出：`docs/README.md`、`docs/contributing.md`、任务模板片段。
- 依赖：无。
- 执行步骤：
  - 创建目录与文档骨架；写入项目简介与开发约定。
  - 在 README 中链接两份设计与 ToDoList 文档。
- 验收：文档存在且内容完整，链接可用。
- 预计耗时：0.5 天。
- 备注：已于 2025-10-22 完成，`docs/README.md` 链接到设计与 ToDoList，文档结构就绪。

2) [M0-02] 环境准备文档（状态：completed）
- 描述：编写 Node、Docker、SQLite WAL、时区设置、浏览器支持说明。
- 产出：`docs/environment.md`。
- 依赖：M0-01。
- 执行步骤：明确版本、安装步骤、常见问题与验证命令。
- 验收：可按文档在全新机器完成环境准备。
- 预计耗时：0.5 天。
- 备注：已于 2025-10-22 完成，涵盖 Node/Docker/SQLite WAL/时区/浏览器与运行流程；已补充限流环境变量（`RATE_LIMIT_WINDOW_SEC`、`RATE_LIMIT_MAX`）。

3) [M0-03] 代码风格与提交规范（状态：completed）
- 描述：定义 ESLint/Prettier 规则、提交消息规范、分支命名。
- 产出：`docs/standards.md`。
- 依赖：M0-01。
- 执行步骤：列出规则与示例；约定 `feat/fix/docs/chore` 格式。
- 验收：规范清晰、可执行。
- 预计耗时：0.5 天。
- 备注：已于 2025-10-22 完成，`docs/standards.md` 与 `docs/contributing.md` 生效。

4) [M0-04] 安全与权限策略概要（状态：completed）
- 描述：记录角色、ACL、行/列只读、匿名访问控制策略。
- 产出：`docs/security.md`。
- 依赖：M0-01。
- 执行步骤：结合设计文档细化接口校验与前端禁用逻辑。
- 验收：策略覆盖 MVP 范围，边界明确。
- 预计耗时：0.5 天。
- 备注：已于 2025-10-22 完成，`docs/security.md` 明确角色/ACL/只读与校验点。

5) [M0-05] 风险与回滚计划（状态：completed）
- 描述：列出公式一致性、导入匹配、移动端体验、权限校验等风险与回滚步骤。
- 产出：`docs/risks.md`。
- 依赖：M0-01。
- 执行步骤：按风险级别标记；准备回滚与替代方案。
- 验收：风险可追踪、措施清晰。
- 预计耗时：0.5 天。
- 备注：已于 2025-10-22 完成，`docs/risks.md` 列出主要风险与应急处理流程。

---

### 里程碑1：后端基础（NestJS + Prisma + SQLite + 权限 + EAV）
1) [M1-01] 初始化 NestJS 项目结构（状态：completed）
- 描述：创建 NestJS 项目骨架（暂不执行脚手架，记录步骤）。
- 产出：初始化步骤文档 `docs/backend-setup.md`。
- 依赖：M0-02。
- 执行步骤：记录 `nest new` 参数、模块划分（auth/tables/fields/records/views/attachments/logs）。
- 验收：步骤可复用，无歧义。
- 预计耗时：0.5 天。
- 备注：已于 2025-10-22 完成，项目已初始化至 `server/`，使用 pnpm 与 NestJS 11。

2) [M1-02] Prisma Schema 设计（EAV）（状态：completed）
- 描述：将设计文档中的表结构转为 Prisma schema。
- 产出：`prisma/schema.prisma`（设计稿）。
- 依赖：M1-01。
- 执行步骤：定义 models、关系与索引；添加 WAL 说明与迁移计划。
- 验收：Schema 完整并可迁移；关系正确。
- 预计耗时：1 天。
- 备注：已于 2025-10-22 完成，`prisma/schema.prisma` 校验通过，`pnpm prisma migrate dev` 已应用，SQLite 位于 `server/data/app.db`。

3) [M1-03] 认证与角色（JWT + 哈希）（状态：in_progress）
- 描述：实现登录、登出、查询当前用户；角色 `viewer/editor/exporter/admin`。
- 产出：`/auth/login`、`/auth/logout`、`/auth/me` 接口设计与伪代码。
- 依赖：M1-01、M1-02。
- 执行步骤：Argon2/BCrypt 哈希；JWT 策略与守卫；速率限制与输入校验记录。
- 验收：接口描述与校验流程完整；含错误码约定。
- 预计耗时：1 天。
- 备注：已于 2025-10-22 持续推进；已完成：全局 ValidationPipe、统一异常过滤器（含 429 → RATE_LIMITED）、`RateLimitGuard` 登录限流（5/60，IP+路径）、`/api/auth/admin-check`（JwtAuthGuard + RolesGuard）。未完成：密码哈希与用户种子、Users 管理接口接入 RolesGuard、登录/导入/导出/保存审计日志。

4) [M1-04] 表与字段 CRUD（状态：pending）
- 描述：`/tables`、`/tables/:id/fields` 基本增删改查。
- 产出：接口契约与伪代码；字段类型与 options_json 解析规则。
- 依赖：M1-02。
- 执行步骤：校验必填/默认值/只读标记；order_index 管理。
- 验收：契约完整，含权限校验点。
- 预计耗时：1 天。

5) [M1-05] 记录与单元格写入（批量）（状态：pending）
- 描述：`/tables/:id/records`、`POST /tables/:id/cells/batch`；校验行/列只读与 `revision`。
- 产出：批量契约、事务写入流程、错误码设计。
- 依赖：M1-02、M1-04。
- 执行步骤：事务；回滚策略；值类型与 formula_expr 字段关系。
- 验收：流程覆盖常见场景；含并发冲突处理。
- 预计耗时：1.5 天。

6) [M1-06] 视图配置与数据读取（状态：pending）
- 描述：`/tables/:id/views`、`GET /views/:id/data`；过滤/排序/分组/聚合。
- 产出：视图 config_json 规范；数据读取契约。
- 依赖：M1-02、M1-04、M1-05。
- 执行步骤：统一查询层；分页与虚拟滚动支撑。
- 验收：契约清晰；示例请求响应。
- 预计耗时：1.5 天。

7) [M1-07] 附件上传与下载（状态：completed）
- 描述：`POST /attachments/upload`、`GET /attachments/:id/download`；大小/类型校验与重命名策略。
- 产出：接口契约与存储结构说明；E2E 覆盖上传与下载（文本示例）。
- 依赖：M1-02。
- 执行步骤：Multer 配置；路径方案；硬删流程；下载对 `text/plain` 直接返回文本，其余流式附件。
- 验收：契约与示例；错误处理清晰；E2E 通过。
- 预计耗时：1 天。
- 备注：已于 2025-10-22 完成；修复 Jest 环境下动态导入与 MIME 设置问题；完善下载响应头；E2E 通过。

8) [M1-08] 导入导出接口（状态：in_progress）
- 描述：`POST /tables/:id/import`、`POST /views/:id/export`、`POST /tables/:id/export`；宽松匹配与新字段创建（导入）。
- 产出：视图与表级 CSV 导出；审计记录；导入设计未实现。
- 依赖：M1-02、M1-04、M1-05。
- 执行步骤：导出使用 `RecordsService.list` 聚合数据、按字段顺序生成 CSV、记录日志；导入解析策略待实现。
- 验收：导出 E2E 通过；权限生效；导入计划明确。
- 预计耗时：1.5 天（导出已完结部分）。
- 备注：已于 2025-10-22 完成视图与表级导出（CSV）；E2E 建议串行 `--runInBand` 避免并发种子冲突。
- 描述：`POST /tables/:id/import`、`GET /tables/:id/export`；宽松匹配与新字段创建。
- 产出：列映射策略与示例；本地化解析规则。
- 依赖：M1-02、M1-04、M1-05。
- 执行步骤：解析库选择；错误与审计。
- 验收：契约可实现；覆盖边界情况。
- 预计耗时：1.5 天。

9) [M1-09] 日志审计（状态：pending）
- 描述：`logs` 记录登录/导入/导出/保存；管理员查询。
- 产出：`GET /logs` 契约与字段定义。
- 依赖：M1-03、M1-08。
- 执行步骤：事件写入点与结构；隐私与合规说明。
- 验收：日志字段完整；查询支持分页。
- 预计耗时：0.5 天。

10) [M1-10] 版本控制与并发（状态：pending）
- 描述：`revision` 维护与 `409 Conflict` 流程；不允许强制覆盖。
- 产出：保存流程图与时序图；错误提示格式约定。
- 依赖：M1-05、M1-06。
- 执行步骤：更新策略；视图与表版本统一处理。
- 验收：流程闭环；边界明确。
- 预计耗时：0.5 天。

11) [M1-11] 后端测试清单（状态：pending）
- 描述：为认证、ACL、CRUD、批量写入、视图查询、导入导出、附件、日志编写测试计划。
- 产出：`docs/backend-tests.md`。
- 依赖：全部后端接口契约草拟完成。
- 执行步骤：单元/集成测试范围定义；数据种子说明。
- 验收：可指导落地测试实现。
- 预计耗时：1 天。

---

### 里程碑2：前端网格视图与导入导出（Vue3 + Element Plus + Luckysheet）
1) [M2-01] 前端项目结构设计（状态：pending）
- 描述：记录 Vite、Router、Pinia、Axios、Element Plus 初始化步骤与目录规划。
- 产出：`docs/frontend-setup.md`。
- 依赖：M0-02。
- 执行步骤：目录（views/components/stores/services）；主题与中文本地化。
- 验收：可按文档初始化项目。
- 预计耗时：0.5 天。

2) [M2-02] 认证与路由守卫（状态：pending）
- 描述：登录页、Token 管理、路由守卫、角色控制与 ACL。
- 产出：路由与守卫设计；状态结构说明。
- 依赖：M1-03。
- 执行步骤：`authStore` 定义；错误提示与跳转策略。
- 验收：流程清晰；边界覆盖。
- 预计耗时：0.5 天。

3) [M2-03] 表列表与详情页框架（状态：pending）
- 描述：`/tables` 列表、`/tables/:id` 详情，视图切换（网格/看板/画廊/分组）。
- 产出：页面结构与组件关系图。
- 依赖：M1-04、M1-06。
- 执行步骤：Element Plus 布局；菜单与操作区设计。
- 验收：结构合理；可容纳后续功能。
- 预计耗时：1 天。

4) [M2-04] Luckysheet 网格集成与 EAV 映射（状态：pending）
- 描述：将 EAV 数据映射到 Luckysheet；公式即时重算与脏标记。
- 产出：映射层设计与数据流说明。
- 依赖：M1-05、M1-06。
- 执行步骤：列字段类型渲染；只读行/列禁用编辑。
- 验收：基本编辑与公式运行正常；性能可用。
- 预计耗时：2 天。

5) [M2-05] 批量保存与版本冲突处理（状态：pending）
- 描述：将网格编辑变更批量提交；处理 `409 Conflict` 刷新提示。
- 产出：保存流程与错误提示设计。
- 依赖：M1-10。
- 执行步骤：收集变更；校验只读；携带 `revision`；界面提示。
- 验收：冲突场景提示准确；数据一致。
- 预计耗时：1 天。

6) [M2-06] 过滤与排序 UI（状态：pending）
- 描述：多条件 AND 过滤与排序；保存筛选条件到视图配置。
- 产出：过滤组件与视图配置写回流程。
- 依赖：M1-06。
- 执行步骤：支持类型化条件；联动聚合。
- 验收：条件持久化；与数据读取一致。
- 预计耗时：1 天。

7) [M2-07] 导入（CSV/Excel）前端流程（状态：pending）
- 描述：上传解析、列头宽松匹配、不可识别列创建新字段、预览与确认。
- 产出：导入向导组件与交互说明。
- 依赖：M1-08。
- 执行步骤：本地化解析（数字/日期）；错误反馈与日志。
- 验收：导入成功与回滚清晰；审计记录触发。
- 预计耗时：1.5 天。

8) [M2-08] 导出流程与权限校验（状态：pending）
- 描述：导出当前视图过滤结果；权限由创建者配置，默认 `exporter/admin/editor` 可导出。
- 产出：导出按钮与进度反馈；文件生成流程。
- 依赖：M1-08、M1-03。
- 执行步骤：后端接口调用；无权限提示；审计记录。
- 验收：导出文件正确；权限生效。
- 预计耗时：0.5 天。

9) [M2-09] 虚拟滚动与性能优化（状态：pending）
- 描述：大表数据的懒加载与虚拟渲染；交互顺畅。
- 产出：性能策略与阈值设定。
- 依赖：M2-04。
- 执行步骤：分页/分块加载；滚动阈值；缓存。
- 验收：1000×100 达到可用性要求。
- 预计耗时：1 天。

10) [M2-10] 前端测试与验收（状态：pending）
- 描述：编写关键交互测试计划；手测脚本与 DoD 清单。
- 产出：`docs/frontend-tests.md`。
- 依赖：M2 全部功能。
- 执行步骤：场景列表；问题记录模板。
- 验收：测试计划可指导落地实现。
- 预计耗时：1 天。

---

### 里程碑3：看板 / 画廊 / 分组聚合
1) [M3-01] 看板视图（状态：pending）
- 描述：单选/状态字段分列；拖拽更新写回；只读不可拖拽。
- 产出：看板组件与数据映射。
- 依赖：M1-06、M2-03。
- 执行步骤：列生成；拖拽库集成；批量保存。
- 验收：交互稳定；权限生效。
- 预计耗时：1 天。

2) [M3-02] 画廊视图（状态：pending）
- 描述：以附件字段为卡片封面（显示文件类型与名称）；支持下载。
- 产出：画廊组件；附件展示策略。
- 依赖：M1-07、M2-03。
- 执行步骤：卡片布局；权限与只读标识显示。
- 验收：展示正确；下载可用。
- 预计耗时：1 天。

3) [M3-03] 分组与聚合（状态：pending）
- 描述：单字段分组；聚合函数 `sum/avg/min/max/count`；对过滤结果进行聚合；缓存策略。
- 产出：分组面板与聚合结果展示；后端查询优化。
- 依赖：M1-06、M2-06。
- 执行步骤：查询参数；结果渲染；缓存失效。
- 验收：数值正确；性能可用。
- 预计耗时：1.5 天。

4) [M3-04] 视图配置持久化与切换体验（状态：pending）
- 描述：不同视图的配置读写与切换流畅性；保留筛选与排序。
- 产出：统一视图配置层。
- 依赖：M2-03。
- 执行步骤：配置写回；版本号校验。
- 验收：切换无异常；状态一致。
- 预计耗时：0.5 天。

5) [M3-05] 前后端联合验收（状态：pending）
- 描述：覆盖看板、画廊、分组聚合功能的端到端测试计划。
- 产出：验收报告与问题清单。
- 依赖：M3-01~M3-04。
- 执行步骤：场景执行；问题修复计划。
- 验收：关键场景通过；问题闭环。
- 预计耗时：1 天。

---

### 里程碑4：Docker 化与发布
1) [M4-01] 后端 Dockerfile 与 Compose（状态：pending）
- 描述：后端镜像构建；端口 `8080`；DB 与 `uploads/` 卷映射；时区 `Asia/Shanghai`。
- 产出：`Dockerfile.backend`、`docker-compose.yml`。
- 依赖：M1。
- 执行步骤：镜像优化；环境变量；健康检查。
- 验收：容器可启动并工作。
- 预计耗时：0.5 天。

2) [M4-02] 前端 Dockerfile 与静态资源部署（状态：pending）
- 描述：前端打包镜像；端口 `5173` 或静态托管端口；反向代理说明。
- 产出：`Dockerfile.frontend`。
- 依赖：M2。
- 执行步骤：生产构建；缓存策略；资源按需加载。
- 验收：前端可访问并与后端通信。
- 预计耗时：0.5 天。

3) [M4-03] 备份与恢复指南（状态：pending）
- 描述：DB 文件与附件目录备份；恢复流程。
- 产出：`docs/backup-restore.md`。
- 依赖：M4-01。
- 执行步骤：脚本与计划；验证清单。
- 验收：在测试环境完成一次完整备份恢复演练。
- 预计耗时：0.5 天。

4) [M4-04] 发布与上线验收（状态：pending）
- 描述：部署步骤、环境变量、权限配置、最终验收清单。
- 产出：`docs/release-checklist.md`。
- 依赖：M4-01、M4-02。
- 执行步骤：按清单执行；记录问题与解决。
- 验收：上线通过；文档完备。
- 预计耗时：0.5 天。

---

## 验收清单与测试矩阵（摘要）
- 后端：认证、ACL、CRUD、批量写入、视图查询、导入导出、附件、日志、并发冲突。
- 前端：登录守卫、网格编辑与公式重算、只读禁用、保存与冲突、过滤排序、导入导出、虚拟滚动、看板拖拽、画廊展示、分组聚合。
- 端到端：典型工作流（创建表→导入→编辑→保存→导出→看板/画廊/分组聚合）。

---

## 日常执行规则
- 每次开始工作：将当前任务状态改为 `in_progress`，其他保持原状；完成后立即标为 `completed`。
- 遇到阻塞：新建对应 `blocked` 子任务并记录原因与解法；原任务保持 `in_progress` 不闭合。
- 产生 UI 变更：完成开发后打开本地预览检查界面与交互；记录截图与问题。
- 中断或遗忘：回到本文档，从最近未完成的任务继续；不得跳跃。
- 变更需求：追加新任务到对应里程碑，不改已完成任务；评审后执行。
- 循环事项：每个小步骤完成后，必须同步更新 ToDoList 状态并复核本规则，若遗漏优先补记后再执行下一步。

---

## 任务模板（复制使用）