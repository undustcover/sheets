# 轻量级多维表格设计方案（MVP，含最新澄清）

## 1. 项目概览
- 目标：交付本地可部署的轻量级多维表格系统（中文 UI），支持网格/看板/画廊视图、基础公式（四则/汇总/区域引用）、分组与聚合、导入导出、附件管理、表级权限与行/列只读限制、视图级匿名访问（最多三视图）。
- 并发模型：手动保存、最后保存生效（无实时协作）；后端事务与 `revision` 校验避免覆盖；冲突返回 409 并提示刷新，不提供强制覆盖。
- 性能目标：≤1000 行 × ≤100 列；虚拟滚动与分页；带宽假设 1MB/s。

## 2. 技术栈与约定（更新）
- 前端：Vue3 + Vite + TypeScript + Element Plus + Pinia + Vue Router + Axios；网格内核 Luckysheet（内置公式）。
- 后端：NestJS + Prisma + SQLite（启用 WAL）+ JWT；Multer（磁盘上传）、xlsx、csv-parse。
- 仓库结构：单仓库，`server/` + `web/` + `docs/` + `data/` + `uploads/`。
- 包管理器：统一使用 `pnpm`。
- 部署：Dockerfile + docker-compose，端口：后端 `8080`，前端 `5173`；挂载卷：SQLite DB 与 `uploads/`；时区 `Asia/Shanghai`。
- 浏览器支持：桌面 Chrome/Edge，移动端浏览器（网格编辑降级，保留浏览/检索）。

## 3. 认证与权限（更新）
- 认证：用户名+密码（Argon2 哈希）；JWT 会话，访问令牌有效期 2 小时；MVP 不做刷新令牌。
- 初始管理员：不自动创建，需手动创建或通过种子脚本。
- 角色：`viewer`（只读）、`editor`（读写）、`exporter`（读写+导出）、`admin`（管理）。
- 表级 ACL：为用户分配角色，控制读/写/导出。
- 导出权限：默认 `exporter/admin/editor` 可导出，`viewer` 不可；创建者可配置。
- 行/列只读：`fields.readonly/readonly_roles`、`records.readonly/readonly_roles`；只读优先生效（即使 ACL 允许写入也拒绝）。
- 匿名访问：支持视图级匿名访问开关；每个表最多 3 个视图。

## 4. 公式与视图系统（更新）
- 公式范围：
  - 支持 `+ - * /` 与同表汇总（`sum/avg/min/max/count`），支持区域/跨行引用（如 `SUM(A1:A10)`）。
  - 主方案：单元格级公式（`cell_values.formula_expr`）作为一等公民；字段级计算列（`fields.type=formula`）可选保留但不必需，若启用仅支持按记录计算，不含区域引用。
- 视图系统：
  - 网格视图（主编辑）：虚拟渲染、内联编辑、即时公式重算、批量保存。
  - 看板视图：基于单选/状态字段为列，拖拽更新写回。
  - 画廊视图：基于附件字段展示卡片（不预览内容，显示类型与名称）。
  - 分组与聚合：单字段分组；`sum/avg/min/max/count`；支持对当前过滤结果进行聚合；多层分组暂缓迭代。
- Luckysheet 映射：每个表维护一个工作簿（Workbook）与一个主工作表（Worksheet）；最多 3 个视图共享同一工作表数据，不同视图通过配置（过滤/排序/分组/聚合）呈现。

## 5. 导入与导出（更新）
- 导入（CSV/Excel）：
  - 列头宽松匹配（忽略大小写/空白/全角半角差异）。
  - 无法识别列将创建新字段，默认类型为“文本”。
  - 数值与日期进行本地化解析（千分位、小数点、`YYYY-MM-DD`）。
  - 文件大小限制：≤10MB/次（避免前端卡顿，后端可行流式解析）。
- 导出：
  - 默认导出当前视图过滤结果；权限按表配置；审计记录导出文件的记录数与字段数，不存储文件内容或样本。

## 6. 附件管理（更新）
- 类型白名单：图片、PDF、MS Office 常见 MIME，其他拒绝。
- 大小与配额：单文件 ≤50MB，全站统一配额 10GB。
- 存储结构：`uploads/{table_id}/{record_id}/{field_id}/stored_name`；保存原始文件名与 MIME。
- 冲突策略：重命名（追加时间戳/计数）；删除策略为硬删；通过外键关系避免孤儿文件。

## 7. 数据模型（EAV，更新字段）
- `users(id, username(unique), password_hash, role(enum), created_at)`
- `tables(id, name, revision, created_by, created_at, updated_at)`
- `fields(id, table_id(FK), name, type(enum:text|number|single_select|multi_select|date|attachment|boolean|formula?), options_json, required, default_json, order_index, readonly(bool), readonly_roles(json))`
- `records(id, table_id(FK), order_index, created_at, updated_at, readonly(bool), readonly_roles(json))`
- `cell_values(id, table_id(FK), record_id(FK), field_id(FK), value_json, formula_expr, computed_at, is_dirty(bool))`
- `views(id, table_id(FK), name, type(enum:grid|kanban|gallery|group), config_json(filters/sort/group/agg/kanbanMap/galleryField), revision, order_index, anonymous_enabled(bool))`
- `table_acl(id, table_id(FK), user_id(FK), role(enum))`
- `attachments(id, table_id(FK), record_id(FK), field_id(FK), filename_original, stored_name, path, size, mime, created_at)`
- `logs(id, user_id(FK), action(enum:login|import|export|save), table_id(FK), view_id(FK), meta_json, created_at)`
- 业务约束：每个表的视图数量 ≤ 3；只读优先生效。
- 索引优化：`table_id/field_id/record_id` 索引；分组字段附加索引；SQLite WAL。

## 8. 接口设计（REST）
- 认证：`POST /auth/login`、`POST /auth/logout`、`GET /auth/me`
- 表与字段：`GET/POST/PUT/DELETE /tables`、`GET/POST/PUT/DELETE /tables/:id/fields`
- 记录与单元格：`GET/POST/PUT/DELETE /tables/:id/records`（分页、过滤、排序）；`POST /tables/:id/cells/batch`（批量写入，校验行/列只读与 `revision`）
- 视图：`GET/POST/PUT/DELETE /tables/:id/views`（含 `anonymous_enabled`）；`GET /views/:id/data`（按配置返回数据，支持过滤、排序、分组与聚合）
- 导入导出：`POST /tables/:id/import`（宽松匹配与新字段创建、≤10MB）；`GET /tables/:id/export?format=csv|xlsx&scope=view|all`（权限校验，默认导出当前视图）
- 附件：`POST /attachments/upload`（大小/类型校验与重命名）；`GET /attachments/:id/download`
- 权限与只读：`GET/POST /tables/:id/acl`；`GET/POST /tables/:id/readonly`（字段/行只读配置）
- 审计日志：`GET /logs`（管理员分页查看）

## 9. 前端架构与路由
- 路由：`/login` 登录；`/tables` 表列表；`/tables/:id` 表详情（视图切换：网格/看板/画廊/分组）；`/tables/:id/settings` 字段/权限/导入导出配置。
- 状态管理：`authStore`（用户与角色）、`tableStore`（表/字段/记录、只读标记、revision）、`viewStore`（视图配置、过滤与排序、聚合结果、匿名开关）、`attachmentStore`（上传与列表）。
- 交互与保存：Luckysheet 网格映射 EAV；编辑即时计算公式并标记未保存；批量保存携带 `revision`；看板拖拽更新单选字段；画廊显示附件卡片与下载；过滤与排序保存到视图配置。

## 10. 过滤/排序/分页协议（更新）
- 过滤 DSL：`[{ fieldId, op, value }]`（多条件 AND）。
- 排序：`[{ fieldId, direction }]`。
- 分页：`page, size` 参数；服务端分页与前端虚拟滚动结合。

## 11. 并发与版本控制
- `tables.revision` 与 `views.revision` 随保存递增；客户端保存时携带版本。
- 冲突处理：后端返回 `409 Conflict` 与最新版本；前端提示刷新数据；不提供强制覆盖。

## 12. 安全与合规
- 输入校验、CORS、速率限制、XSS/注入防护（Prisma）；敏感配置（`JWT_SECRET`、`DATABASE_URL`）安全管理。
- 双重校验：前端禁用只读编辑；后端拒绝越权写入。
- 审计日志：记录登录/导入/导出/保存（导出仅记录条数字段数）。

## 13. 性能优化
- 网格虚拟滚动与分页分块加载；聚合查询用 `GROUP BY`；按过滤条件键值缓存聚合结果并失效重算。

## 14. Docker 与部署（更新）
- 后端镜像：端口 `8080`；挂载 `data/`、`uploads/`；`ENV TZ=Asia/Shanghai`。
- 前端生产：打包为静态资源（Nginx/后端静态托管）；开发端口 `5173` 仅用于本地开发。
- 备份：定期卷备份或导出 DB 文件；附件目录归档（见 `docs/backup-restore.md`）。

## 15. 里程碑与测试策略（更新）
- 里程碑0：准备与规范（已完成）。
- 里程碑1：后端基础（EAV/认证/权限/REST/附件/导入导出/日志/并发）与接口契约/伪代码。
- 里程碑2：前端网格（Luckysheet 集成、过滤排序、批量保存与冲突处理）、导入导出。
- 里程碑3：看板/画廊/分组聚合与缓存策略、视图匿名开关。
- 里程碑4：Docker 化与发布、备份策略。
- 测试策略：后端集成测试覆盖关键路径；前端以手测清单为主并对核心交互（认证、保存、冲突提示）做少量自动化测试。

## 16. 风险与控制（摘要）
- 公式一致性、权限边界、导入解析、本地化、移动端体验、聚合性能、附件清理；对应的控制与回滚方案详见 `docs/risks.md`。

## 17. 澄清同步（2025-10-22）
- 仓库结构：确认仓库根创建 `server/` 与 `web/` 两目录，并行初始化；SQLite 文件路径为 `f:\trae\sheets\data\app.db`。
- 运行版本：统一使用 `Node 20 LTS` 与 `NestJS 10.x`。
- 工作空间：使用 `pnpm` workspace；根 `package.json` 管理；`server` 与 `web` 均作为 workspace 包初始化。
- 环境变量：`.env` 位于 `server/`；包含 `JWT_SECRET`、`DATABASE_URL=file:../data/app.db`、`TZ=Asia/Shanghai`。
- CORS：开发允许 `http://localhost:5173`；生产仅允许静态前端部署域名；无其他来源。
- 登录限流：确认“每 IP 每分钟 10 次”，超限返回 `429 RATE_LIMITED`。
- 附件策略：白名单为图片、PDF、Office 文档；不扩展 `text/plain` 与 `application/json`；单文件 ≤50MB，总配额 10GB。
- 导入解析：CSV/Excel ≤10MB；默认区域设置为 `zh-CN`；列头宽松匹配，未知列创建文本字段。
- 匿名视图：字段返回集合仅按视图配置决定，不做默认屏蔽（如 `attachment`、`formula` 不额外处理）。
- 日志保留：审计日志保留 90 天，滚动清理。

## 18. 当前实现进度与偏差说明（2025-10-22）
- 已实现
  - `GET /api/tables/:id/records` 支持分页、过滤（AND）与排序。
  - 公式同步计算：记录写入后按 `cell_values.formula_expr` 立即计算，支持 `+ - * /` 与按字段名引用数值字段；结果写入 `value_json` 与 `computed_at`。
  - 基础认证防线：全局校验、异常过滤、登录限流、`JwtAuthGuard/RolesGuard` 管道；`/api/auth/admin-check` 用于验证守卫。

- 未实现/待完善
  - 视图与聚合接口（`/tables/:id/views`、`GET /views/:id/data`）。
  - 记录与单元格批量写入接口与 `revision` 并发控制。
  - 用户/角色管理接口与密码哈希/种子、审计日志。
  - 导入导出与附件模块。

- 临时约束
  - 过滤 DSL 暂支持类型化简单比较与多条件 AND；后续扩展数组字段（包含/不包含）与日期区间。
  - 公式暂不支持区域引用与聚合函数；前端集成后由 Luckysheet 运行复杂公式。

## 19. 下步开发计划（迭代优先级）
- 完成 M1-03 Users 管理与密码哈希/种子。
- 实现 M1-04 表/字段 CRUD（含只读与 options_json 解析）。
- 草拟并实现 M1-05 批量写入契约（事务与 `revision` 并发控制）。
- 统一查询层与视图契约（M1-06），为前端集成做准备。
- 预研前端 M2-01~M2-04（项目骨架、路由守卫、表页面框架、Luckysheet 映射）。

—— 完 ——